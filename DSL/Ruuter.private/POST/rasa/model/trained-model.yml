declaration:
  call: declare
  version: 0.1
  description: "Decription placeholder for 'TRAINED-MODEL'"
  method: post
  accepts: json
  returns: json
  namespace: model
  allowlist:
    body:
      - field: versionNumber
        type: string
        description: "Body field 'versionNumber'"

checkIncomingBody:
  switch:
    - condition: ${incoming.body.versionNumber.length > 0}
      next: getModelFileNameByVersionNumber
  next: getLatestReadyModelFileName

getModelFileNameByVersionNumber:
  call: http.post
  args:
    url: "[#TRAINING_RESQL]/get-ready-model-by-version-number"
    body:
      versionNumber: ${incoming.body.versionNumber}
  result: resqlResponse
  next: checkResqlResponse

getLatestReadyModelFileName:
  call: http.post
  args:
    url: "[#TRAINING_RESQL]/get-latest-ready-model"
  result: resqlResponse

checkResqlResponse:
  switch:
    - condition: ${resqlResponse.response.body.length == 0}
      next: returnModelNotFoundInDatabase
  next: copyFileFromRemoteToLocal

copyFileFromRemoteToLocal:
  call: http.post
  args:
    url: "[#S3_FERRY]/v1/files/copy"
    body:
      destinationFilePath: ${resqlResponse.response.body[0].fileName}
      destinationStorageType: "FS"
      sourceFilePath: ${resqlResponse.response.body[0].fileName}
      sourceStorageType: "S3"
  result: copyResponse

checkCopyResponse:
  switch:
    - condition: ${copyResponse.response.statusCodeValue == 201 }
      next: loadTrainedModel
  next: returnModelCopyingFailed

loadTrainedModel:
  call: http.put
  args:
    url: "[#TRAINING_RASA]/model"
    body:
      model_file: "/app/models/${resqlResponse.response.body[0].fileName}"
  result: loadResponse   

checkLoadedModelResponse:
  switch:
    - condition: ${loadResponse.response.statusCodeValue == 204 }
      next: addDeployedModelToDatabase
  next: returnModelLoadingFailed

addDeployedModelToDatabase:
  call: http.post
  args:
    url: "[#TRAINING_RESQL]/add-llm-trainings"
    body:
      model_type: ${resqlResponse.response.body[0].modelType}
      state: "DEPLOYED"
      file_name: ${resqlResponse.response.body[0].fileName}
      version_number: ${resqlResponse.response.body[0].versionNumber}
      model_version: ${resqlResponse.response.body[0].modelVersion}
      test_report: ""
      cross_validation_report: ""
  next: returnSuccess

returnSuccess:
  return: "Model copied and loaded successfully"
  wrapper: false
  next: end

returnModelNotFoundInDatabase:
  return: "error: specified model not found in the database"
  next: end

returnModelCopyingFailed:
  return: "error: model copying from remote to local storage failed"
  next: end

returnModelLoadingFailed:
  return: "error: failed to load trained model from RASA"
  next: end
